---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes

- name: Install dependencies
  ansible.builtin.apt:
    name:
      - curl
      - gnupg2
      - ca-certificates
    state: present

- name: Fetch latest Coder release from GitHub
  ansible.builtin.uri:
    url: https://api.github.com/repos/coder/coder/releases/latest
    return_content: yes
    headers:
      Accept: application/vnd.github+json
  register: github_release

- name: Set deb_package_name variable based on architecture
  ansible.builtin.set_fact:
    deb_package_name: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"

- name: Download Coder v2 .deb package
  ansible.builtin.get_url:
    url: "{{ github_release.json.assets | selectattr('name', 'match', 'coder_.*_linux_' + deb_package_name + '\\.deb$') | map(attribute='browser_download_url') | first }}"
    dest: "/tmp/coder.deb"
    mode: '0755'

- name: Install Coder v2 .deb package
  ansible.builtin.apt:
    deb: "/tmp/coder.deb"
    state: present

- name: Create /etc/coder directory
  ansible.builtin.file:
    path: /etc/coder.d
    state: directory
    mode: '0755'

- name: Create coder.env configuration file
  ansible.builtin.template:
    src: coder.env.j2
    dest: /etc/coder.d/coder.env
    mode: '0644'

- name: Enable and start Coder v2 service
  ansible.builtin.systemd:
    name: coder
    state: started
    enabled: true
